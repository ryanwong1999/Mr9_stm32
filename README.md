# Mr9_stm32

Copyright (C) ".strftime("%Y")." All rights reserved.

**工程名称：**	MR9_V4

**作    者：**	hrx

**创建时间：**	2022年02月25日

**软件版本：**	V4.0

**硬件版本：**	V4.0

**硬件说明：**

		(1) 控制板: MR9_v4.pcb
	
		(2) 电机: 
	
						室内机器人：北京和利时电机 10530NA1550F22-V2.3 , 编码器线数1400, DC24V ,输出功率160W, 额定电流14A,最大电流27A, 额定转速200rpm, 最高转速500rpm,  额定转矩8Nm,最大转矩15Nm;
	
						室外机器人：
	
						电池: 铁锂电池5S6P，16V21AH



### 不同电机的区别:  南京纳帝机电和北京和利时电机

​	(1)编码数不一样，一个是139转，一个是1400转;

​	(2)脉冲采样方式不一样, 139转电机只用一路输入捕获, 通过下发的速度来判断方向（该方法有可能会误判断方向），1400转电机脉冲采样有AB相，需要两路输入捕获，通过两路相位差来判断方向;

​	(3)速度处理方式不一样，139转电机采用简单的PWM加减处理，1400转电机采用PID算法处理;
​			  

### 工程说明：App_Task.c

		**(1)Err_Handle_task: ** 异常处理函数，包括看门狗，工控机通信中断处理，驱动通信中断处理，驱动电流过大处理;
	
	    **(2)Poweroff_task: ** 关机任务处理,执行长按3秒后关机;
	
	    **(3)Chg_task: ** 充电处理函数. 检测是否接上充电器，是否正在充电;
	
		**(4)AutoCharge_task: ** 自动充电行走处理, 根据充电桩的红外信号进行自主充电行走;
	
		**(5)Cammand_task: ** 与工控机的命令处理函数, 接收工控机的命令，返回相应信息或执行相应任务;
	
		**(6)Move_Speed_task: ** 行走处理,调节PWM使电机尽快达到设定的线速度和角速度;
	
		**(7)Pmu_task: ** 电源管理处理, 采样各种电压电流值，计算电池容量;
	
		**(8)Head_Ctrl_task: ** 头部控制处理,没有头部摄像头运行控制的，此功能保留;
	
		**(9)Ultrasonic_task: ** 超声测试模块处理,获取超声距离和障碍状态标志;
	
		**(10)Environ_Query_task: ** 发送环境传感器和噪声传感器查询命令;
	
		**(11)Environ_task: ** 获取环境传感器参数和噪声传感器参数;
	
		**(12)LED_task: ** LED指示灯处理;

### 更改记录: 

   (1)20220401: 整合优化源码，将MR9,M100,M200,YZ01C整合成一个程序，通过宏定义来决定用哪一个程序;

		(2)20220425: 增加了驱动过流保护，增加了自动充电检测到驱动过流则往前走一段距离再执行自动充电;
	
		(3)20220527：指示灯优先级更改(将通信中断优先级改成最高)； 驱动过流保护，断开驱动供电电压；跟驱动通信中断，断开驱动电压，10S后恢复驱动供电；超声状态标志恢复改成单独控制;
	
		(4)20220609：增加升降任务禁止时，升降端口当作12V输出，通过宏定义来设定;
	
		(5)20220715：增加检测工控机没开机，指示灯不亮，同时再给开机信号; 增加充电时如果接触不良，则往前走一段距离再重新对接充电桩;
	
		(6)20220723：增加工控机可设置头部偏差，可设置超声禁止使能，并写入到EEROM芯片内;
		(7)20230221：修改电流超过38a停10s，超声停止距离改为40;
	
		(8)20230328：修改10分钟将电量信息（Pms.Capacity_mah）写进at24c02，减少读写次数;
	
		(9)20230328：增加自动校准电池容量;
